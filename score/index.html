<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成绩查询系统 - 1.9.0 by TTchen&xxy150310</title>
    <!-- 引入ECharts图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
        body {background:#f5f5f5;padding:20px;}
        .container {max-width:1200px;margin:0 auto;background:#fff;padding:30px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1);}
        h1 {text-align:center;color:#333;margin-bottom:30px;}
        .refresh-btn {background:#28a745;margin-bottom:20px;}
        .refresh-btn:hover {background:#218838;}
        .search-box {display:flex;gap:10px;margin-bottom:20px;}
        #nameInput {flex:1;padding:10px;font-size:16px;border:1px solid #ddd;border-radius:4px;}
        button {padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:16px;}
        button:hover {background:#0056b3;}
        /* 折线图容器 */
        .chart-area {margin:30px 0;height:400px;border:1px solid #eee;border-radius:8px;padding:10px;display:none;}
        /* 个人统计 */
        .stats-area,.guzhi-area {margin:20px 0;padding:20px;border:1px solid #eee;border-radius:8px;display:none;}
        .stats-area h3,.guzhi-area h3 {color:#333;margin-bottom:10px;}
        .stats-item,.guzhi-item {font-size:18px;margin:8px 0;}
        .stats-item span,.guzhi-item span {color:#007bff;font-weight:bold;}
        /* 排名维度选择 */
        .rank-select {margin:20px 0;}
        .rank-select label {margin-right:20px;cursor:pointer;}
        /* 排名列表 */
        .rank-area,.guzhi-rank-area {margin:30px 0;display:none;}
        .rank-area h3,.guzhi-rank-area h3 {color:#333;margin-bottom:15px;}
        .rank-table,.guzhi-rank-table {width:100%;border-collapse:collapse;}
        .rank-table th, .rank-table td,
        .guzhi-rank-table th, .guzhi-rank-table td {padding:12px;text-align:center;border-bottom:1px solid #ddd;}
        .rank-table th, .guzhi-rank-table th {background:#f8f9fa;}
        .rank-table .my-rank, .guzhi-rank-table .my-rank {background:#fff3cd;color:#856404;font-weight:bold;}
        .no-data {color:#666;text-align:center;padding:20px;}
        .link {text-align:center;margin-top:30px;}
        .link a {color:#007bff;text-decoration:none;}
        .link a:hover {text-decoration:underline;}
    </style>
</head>
<body>
    <div class="container">
        <h1>成绩查询系统 - 1.9.0 by TTchen&xxy150310</h1>

        <!-- 刷新数据 -->
        <button class="refresh-btn" onclick="refreshAllData()">加载最新成绩&咕值数据</button>

        <!-- 查询区域 -->
        <div class="search-box">
            <input type="text" id="nameInput" placeholder="请输入姓名查询成绩&咕值">
            <button onclick="searchScore()">查询成绩&咕值</button>
        </div>

        <!-- 排名维度选择 -->
        <div class="rank-select" id="rankSelect" style="display:none;">
            <label><input type="radio" name="rankType" value="total" checked> 按总分排名</label>
            <label><input type="radio" name="rankType" value="avg"> 按平均分排名</label>
            <button onclick="refreshRank()">刷新成绩排名</button>
            <button onclick="refreshGuzhiRank()" style="margin-left:20px;">刷新咕值排名</button>
        </div>

        <!-- 个人成绩统计 -->
        <div class="stats-area" id="statsArea">
            <h3 id="statsTitle"></h3>
            <div class="stats-item">个人平均分：<span id="userAvg">0</span></div>
            <div class="stats-item">成绩排名：<span id="userRank">0</span> / <span id="totalUser">0</span></div>
        </div>

        <!-- 个人咕值统计 -->
        <div class="guzhi-area" id="guzhiArea">
            <h3 id="guzhiTitle"></h3>
            <div class="guzhi-item">比赛咕值（平均分取整）：<span id="userMatchGuzhi">0</span></div>
            <div class="guzhi-item">基础信用：<span id="userBaseCredit">0</span></div>
            <div class="guzhi-item">练习情况：<span id="userPractice">0</span></div>
            <div class="guzhi-item">成就：<span id="userAchievement">0</span></div>
            <div class="guzhi-item">社区贡献：<span id="userCommunity">0</span></div>
            <div class="guzhi-item" style="font-weight:bold;margin-top:15px;">咕值总分：<span id="userTotalGuzhi">0</span></div>
            <div class="guzhi-item">咕值排名：<span id="userGuzhiRank">0</span> / <span id="totalGuzhiUser">0</span></div>
        </div>

        <!-- 折线图容器 -->
        <div class="chart-area" id="chartArea"></div>

        <!-- 成绩排名列表 -->
        <div class="rank-area" id="rankArea">
            <h3 id="rankTitle">总成绩排名</h3>
            <table class="rank-table">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>用户名</th>
                        <th>参与比赛数</th>
                        <th id="rankCol4">总分</th>
                        <th id="rankCol5">平均分</th>
                    </tr>
                </thead>
                <tbody id="rankBody"></tbody>
            </table>
        </div>

        <!-- 咕值排名列表 -->
        <div class="guzhi-rank-area" id="guzhiRankArea">
            <h3 id="guzhiRankTitle">咕值总分排名</h3>
            <table class="guzhi-rank-table">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>用户名</th>
                        <th>比赛咕值</th>
                        <th>基础信用</th>
                        <th>练习情况</th>
                        <th>成就</th>
                        <th>社区贡献</th>
                        <th>咕值总分</th>
                    </tr>
                </thead>
                <tbody id="guzhiRankBody"></tbody>
            </table>
            
        </div>
        <div class="link"><a href="/">博客首页</a> | <a href="https://github.com/">前往github管理</a></div>
        <div class="tips">支持按时间查看成绩趋势，按总分/平均分/咕值查看排名</div>
        <br>
        <script src="https://giscus.app/client.js"
                data-repo="TT-chen-cqz/giscus"
                data-repo-id="R_kgDOPhi_eA"
                data-category="Announcements"
                data-category-id="DIC_kwDOPhi_eM4CuaMi"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="light"
                data-lang="zh-CN"
                crossorigin="anonymous"
                async>
        </script>
    </div>

    <script>
        let scoreData = [];          // 比赛成绩数据
        let userGuzhiConfig = [];    // 全局用户咕值配置
        let currentUser = '';        // 当前查询的用户
        let userScores = [];         // 当前用户的成绩
        let userStats = {};          // 成绩统计
        let userGuzhi = {};          // 咕值统计
        let allUserStats = [];       // 所有用户成绩统计
        let allUserGuzhi = [];       // 所有用户咕值统计

        // 加载所有数据（成绩+咕值配置）
        function refreshAllData() {
            // 1. 先加载成绩数据
            loadScript('score_data.js', () => {
                scoreData = window.scoreData || [];
                // 2. 再加载咕值配置
                loadScript('user_guzhi.js', () => {
                    userGuzhiConfig = window.userGuzhiConfig || [];
                    // 3. 计算统计数据
                    calcAllUserStats();
                    calcAllUserGuzhi();
                    alert(`加载成功！
成绩数据：${scoreData.length}条
咕值配置：${userGuzhiConfig.length}个用户`);
                });
            });
        }

        // 通用加载JS文件方法
        function loadScript(src, callback) {
            const oldScripts = document.querySelectorAll(`script[src*="${src}"]`);
            oldScripts.forEach(script => script.remove());

            const script = document.createElement('script');
            script.src = src + '?rand=' + Math.random();
            script.type = 'text/javascript';
            script.charset = 'UTF-8';
            script.onload = callback;
            script.onerror = () => alert(`加载${src}失败！请检查文件是否存在`);
            document.body.appendChild(script);
        }

        // 计算所有用户的成绩统计
        function calcAllUserStats() {
            const userMap = {};
            scoreData.forEach(item => {
                if (!userMap[item.name]) {
                    userMap[item.name] = { name: item.name, count: 0, total: 0, avg: 0 };
                }
                userMap[item.name].count++;
                userMap[item.name].total += parseFloat(item.score || 0);
            });
            allUserStats = Object.values(userMap).map(user => {
                user.avg = user.count > 0 ? (user.total / user.count).toFixed(1) : '0.0';
                user.total = user.total.toFixed(1);
                return user;
            });
        }

        // 计算所有用户的咕值统计（关联全局咕值配置）
        function calcAllUserGuzhi() {
            const userMap = {};
            // 1. 统计比赛成绩（用于计算比赛咕值）
            scoreData.forEach(item => {
                if (!userMap[item.name]) {
                    userMap[item.name] = {
                        name: item.name,
                        count: 0,
                        totalScore: 0,
                        matchGuzhi: 0,
                        baseCredit: 0,
                        practice: 0,
                        achievement: 0,
                        community: 0,
                        totalGuzhi: 0
                    };
                }
                userMap[item.name].count++;
                userMap[item.name].totalScore += parseFloat(item.score || 0);
            });

            // 2. 匹配全局咕值配置
            Object.keys(userMap).forEach(name => {
                const guzhi = userGuzhiConfig.find(item => item.name.toLowerCase() === name.toLowerCase()) || {
                    baseCredit: 0, practice: 0, achievement: 0, community: 0
                };
                // 比赛咕值：平均分四舍五入
                userMap[name].matchGuzhi = userMap[name].count > 0 ? Math.round(userMap[name].totalScore / userMap[name].count) : 0;
                // 全局咕值项
                userMap[name].baseCredit = guzhi.baseCredit;
                userMap[name].practice = guzhi.practice;
                userMap[name].achievement = guzhi.achievement;
                userMap[name].community = guzhi.community;
                // 咕值总分
                userMap[name].totalGuzhi = userMap[name].matchGuzhi + guzhi.baseCredit + guzhi.practice + guzhi.achievement + guzhi.community;
            });

            // 3. 补充只有咕值配置但无成绩的用户
            userGuzhiConfig.forEach(guzhi => {
                if (!userMap[guzhi.name]) {
                    userMap[guzhi.name] = {
                        name: guzhi.name,
                        count: 0,
                        totalScore: 0,
                        matchGuzhi: 0,
                        baseCredit: guzhi.baseCredit,
                        practice: guzhi.practice,
                        achievement: guzhi.achievement,
                        community: guzhi.community,
                        totalGuzhi: guzhi.baseCredit + guzhi.practice + guzhi.achievement + guzhi.community
                    };
                }
            });

            allUserGuzhi = Object.values(userMap);
        }

        // 查询用户成绩&咕值
        function searchScore() {
            currentUser = document.getElementById('nameInput').value.trim();
            if (!currentUser) {alert('请输入姓名！');return;}
            if (scoreData.length === 0) {alert('请先点击「加载最新成绩&咕值数据」！');return;}

            // 模糊匹配用户成绩
            userScores = scoreData.filter(item =>
                item.name.toLowerCase().includes(currentUser.toLowerCase())
            ).sort((a, b) => new Date(a.time) - new Date(b.time));

            if (userScores.length === 0) {
                alert('暂无该用户的成绩记录！');
                // 隐藏所有区域
                document.getElementById('statsArea').style.display = 'none';
                document.getElementById('guzhiArea').style.display = 'none';
                document.getElementById('chartArea').style.display = 'none';
                document.getElementById('rankArea').style.display = 'none';
                document.getElementById('guzhiRankArea').style.display = 'none';
                document.getElementById('rankSelect').style.display = 'none';
                return;
            }

            // 计算当前用户的成绩和咕值统计
            calcUserStats();
            calcUserGuzhi();

            // 显示所有区域
            document.getElementById('statsArea').style.display = 'block';
            document.getElementById('guzhiArea').style.display = 'block';
            document.getElementById('chartArea').style.display = 'block';
            document.getElementById('rankArea').style.display = 'block';
            document.getElementById('guzhiRankArea').style.display = 'block';
            document.getElementById('rankSelect').style.display = 'block';

            // 渲染数据
            renderUserStats();
            renderUserGuzhi();
            renderChart();
            refreshRank();
            refreshGuzhiRank();
        }

        // 计算当前用户的成绩统计
        function calcUserStats() {
            const total = userScores.reduce((sum, item) => sum + parseFloat(item.score), 0);
            const avg = (total / userScores.length).toFixed(1);
            userStats = {
                name: currentUser,
                count: userScores.length,
                total: total.toFixed(1),
                avg: avg
            };
        }

        // 计算当前用户的咕值统计（读取全局配置）
        function calcUserGuzhi() {
            // 1. 计算比赛咕值（平均分四舍五入）
            const totalScore = userScores.reduce((sum, item) => sum + parseFloat(item.score), 0);
            const matchGuzhi = Math.round(totalScore / userScores.length);

            // 2. 读取全局咕值配置（不依赖单条比赛数据）
            const userGuzhiItem = userGuzhiConfig.find(item =>
                item.name.toLowerCase() === currentUser.toLowerCase()
            ) || { baseCredit:0, practice:0, achievement:0, community:0 };

            // 3. 计算咕值总分
            const totalGuzhi = matchGuzhi + userGuzhiItem.baseCredit + userGuzhiItem.practice + userGuzhiItem.achievement + userGuzhiItem.community;

            userGuzhi = {
                matchGuzhi: matchGuzhi,
                baseCredit: userGuzhiItem.baseCredit,
                practice: userGuzhiItem.practice,
                achievement: userGuzhiItem.achievement,
                community: userGuzhiItem.community,
                totalGuzhi: totalGuzhi
            };
        }

        // 渲染个人成绩统计
        function renderUserStats() {
            document.getElementById('statsTitle').textContent = `${currentUser}的成绩统计`;
            document.getElementById('userAvg').textContent = userStats.avg;
            document.getElementById('totalUser').textContent = allUserStats.length;
        }

        // 渲染个人咕值统计
        function renderUserGuzhi() {
            document.getElementById('guzhiTitle').textContent = `${currentUser}的咕值统计`;
            document.getElementById('userMatchGuzhi').textContent = userGuzhi.matchGuzhi;
            document.getElementById('userBaseCredit').textContent = userGuzhi.baseCredit;
            document.getElementById('userPractice').textContent = userGuzhi.practice;
            document.getElementById('userAchievement').textContent = userGuzhi.achievement;
            document.getElementById('userCommunity').textContent = userGuzhi.community;
            document.getElementById('userTotalGuzhi').textContent = userGuzhi.totalGuzhi;
            document.getElementById('totalGuzhiUser').textContent = allUserGuzhi.length;
        }

        // 渲染折线图
        function renderChart() {
            const chartDom = document.getElementById('chartArea');
            const myChart = echarts.init(chartDom);

            const sortedScores = [...userScores].sort((a, b) => new Date(a.time) - new Date(b.time));
            const xData = sortedScores.map(item => `${item.time}\n${item.matchName}`);
            const yData = sortedScores.map(item => parseFloat(item.score));

            const option = {
                title: { text: `${currentUser}的成绩趋势图`, left: 'center' },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const idx = params[0].dataIndex;
                        return `${sortedScores[idx].time}<br>${sortedScores[idx].matchName}<br>成绩：${sortedScores[idx].score}`;
                    }
                },
                grid: { left: '8%', right: '4%', bottom: '25%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: xData,
                    axisLabel: { rotate: 60, interval: 0, lineHeight: 20 }
                },
                yAxis: {
                    type: 'value',
                    name: '成绩',
                    min: 0,
                    max: 100,
                    interval: 50,
                    axisLine: { show: true },
                    axisTick: { interval: 1 },
                    splitLine: { lineStyle: { type: 'dashed', opacity: 0.5 } }
                },
                series: [{
                    name: '成绩',
                    type: 'line',
                    data: yData,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    lineStyle: { width: 3, color: '#007bff' },
                    itemStyle: { color: '#007bff' },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                            offset: 0, color: 'rgba(0, 123, 255, 0.3)'
                        }, {
                            offset: 1, color: 'rgba(0, 123, 255, 0.0)'
                        }])
                    }
                }]
            };

            myChart.setOption(option);
            window.addEventListener('resize', () => myChart.resize());
        }

        // 刷新成绩排名
        function refreshRank() {
            if (!currentUser) {return;}
            const rankType = document.querySelector('input[name="rankType"]:checked').value;

            let sortedRank = [...allUserStats];
            if (rankType === 'total') {
                sortedRank.sort((a, b) => parseFloat(b.total) - parseFloat(a.total));
                document.getElementById('rankTitle').textContent = '总成绩排名（降序）';
                document.getElementById('rankCol4').textContent = '总分';
            } else {
                sortedRank.sort((a, b) => parseFloat(b.avg) - parseFloat(a.avg));
                document.getElementById('rankTitle').textContent = '平均分排名（降序）';
                document.getElementById('rankCol4').textContent = '平均分';
            }

            const rankBody = document.getElementById('rankBody');
            rankBody.innerHTML = '';
            let userRank = 0;
            sortedRank.forEach((user, index) => {
                const isCurrentUser = user.name.toLowerCase() === currentUser.toLowerCase();
                if (isCurrentUser) {userRank = index + 1;}
                rankBody.innerHTML += `
                    <tr class="${isCurrentUser ? 'my-rank' : ''}">
                        <td>${index + 1}</td>
                        <td>${user.name}</td>
                        <td>${user.count}</td>
                        <td>${rankType === 'total' ? user.total : user.avg}</td>
                        <td>${user.avg}</td>
                    </tr>
                `;
            });
            document.getElementById('userRank').textContent = userRank;
        }

        // 刷新咕值排名
        function refreshGuzhiRank() {
            if (!currentUser) {return;}

            // 按咕值总分降序排序
            const sortedGuzhi = [...allUserGuzhi].sort((a, b) => b.totalGuzhi - a.totalGuzhi);
            document.getElementById('guzhiRankTitle').textContent = '咕值总分排名（降序）';

            const guzhiRankBody = document.getElementById('guzhiRankBody');
            guzhiRankBody.innerHTML = '';
            let userGuzhiRank = 0;
            sortedGuzhi.forEach((user, index) => {
                const isCurrentUser = user.name.toLowerCase() === currentUser.toLowerCase();
                if (isCurrentUser) {userGuzhiRank = index + 1;}
                guzhiRankBody.innerHTML += `
                    <tr class="${isCurrentUser ? 'my-rank' : ''}">
                        <td>${index + 1}</td>
                        <td>${user.name}</td>
                        <td>${user.matchGuzhi}</td>
                        <td>${user.baseCredit}</td>
                        <td>${user.practice}</td>
                        <td>${user.achievement}</td>
                        <td>${user.community}</td>
                        <td>${user.totalGuzhi}</td>
                    </tr>
                `;
            });
            document.getElementById('userGuzhiRank').textContent = userGuzhiRank;
        }

        // 页面加载自动刷新数据
        window.onload = function() {
            refreshAllData();
        };
    </script>
</body>
</html>
